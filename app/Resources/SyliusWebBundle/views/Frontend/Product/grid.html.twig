{% from '@SyliusWeb/Frontend/Product/macros.html.twig' import grid %}

{% set definition = grid.definition %}
{% set data = grid.data %}

<div class="col-sm-3">
    {% if definition.filters|length > 0 %}
        <form method="GET" id="filterForm" action="{{ path('app_shop_product_index') }}">
            {% for filter in definition.filters %}
                <div class="panel panel-default sidebar-menu filter-panel">
                    <div class="panel-heading">
                        <h3 class="panel-title">{{ filter.label|trans }}</h3>
                    </div>
                    <div class="panel-body hidden">
                        <div class="form-group" id="{{ filter.name }}">
                            {{ sylius_grid_render_filter(grid, filter) }}
                        </div>
                        <div class="btn-group-vertical">
                            <button type="submit" onclick="showClear($(this))" class="btn btn-default btn-sm btn-primary apply">
                                <i class="fa fa-pencil"></i>{{ 'app.ui.apply'|trans }}
                            </button>
                            <button class="btn btn-default btn-sm btn-danger clear hidden" onclick="hideClear($(this))" id="{{ filter.name }}">
                                <i class="fa fa-times-circle"></i>{{ 'app.ui.clear'|trans }}
                            </button>
                        </div>
                    </div>
                    <div class="panel-footer filter-toggle">
                        <h3 class="panel-title clearfix"><a href="#">{{ 'sylius.ui.show'|trans }}<i class="fa fa-arrow-circle-down"></i></a></h3>
                    </div>
                </div>
            {% endfor %}
        </form>
    {% endif %}
</div>

<div class="col-sm-9" id="products">
    {{ include('@SyliusWeb/Frontend/Product/_partialIndex.html.twig') }}
</div>

{% block javascripts %}
    {{ include('@SyliusWeb/_javascripts.html.twig') }}

    <script type="text/javascript">
        $('#products').on('change', '#sortSelect' , function () {
            var filter = $('#filterForm');
            var chosenOption = $(this).val();
            var queryArray = chosenOption.split(' ');
            var sorting = {};
            var queryParameters = {};

            queryParameters[queryArray[0]] = queryArray[1];
            sorting['sorting'] = queryParameters;

            var serializedFilter = filter.serialize();
            var filterData = serializedFilter != null ? serializedFilter + '&' : null;
            var queryData = filterData + $.param(sorting);

            $.ajax({
                type: filter.attr('method'),
                url: filter.attr('action'),
                data: queryData
            }).done(function (data) {
                $('#products').empty().append(data);
                $('#sortSelect').val(chosenOption).change();
            });
        });
    </script>

    <script type="text/javascript">
        function hideClear(element) {
            $(element).addClass('hidden');
        }

        function showClear(element) {
            var buttonGroup = $(element).closest('.btn-group-vertical');
            buttonGroup.find('.clear').removeClass('hidden');
        }
    </script>

    <script type="text/javascript">
        $('#filterForm').submit(function (e) {
            e.preventDefault();

            $.ajax({
                type: $(this).attr('method'),
                url: $(this).attr('action'),
                data: $(this).serialize()
            }).done( function(data) {
                $('#products').empty().append(data);
            });

        });
    </script>

    <script type="text/javascript">
        $('#filterForm').on('click', '.clear', function () {
            $('#products').empty();

            $('#' + $(this).attr('id') + ' :checkbox').removeAttr('checked');
        });
    </script>
{% endblock %}
